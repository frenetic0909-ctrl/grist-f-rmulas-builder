<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Grist Master Formula Builder</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: white; padding: 10px; margin: 0; display: flex; flex-direction: column; height: 100vh; }
    .container { flex: 1; overflow-y: auto; padding: 10px; }
    .card { background: #1e293b; border: 1px solid #334155; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
    
    select, textarea { 
      width: 100%; padding: 10px; background: #0f172a; color: #38bdf8; 
      border: 1px solid #475569; border-radius: 6px; margin-bottom: 10px; box-sizing: border-box;
    }
    
    .selection-list { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
    .badge { background: #3b82f6; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; }
    
    .formula-output { 
      background: #020617; color: #10b981; padding: 15px; border-radius: 6px; 
      font-family: 'Courier New', monospace; font-size: 13px; border: 1px solid #10b981; white-space: pre-wrap;
    }
    
    .btn { padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 5px; }
    .btn-ai { background: #f59e0b; color: #020617; }
    .btn-copy { background: #10b981; color: white; }
    .btn-reset { background: #475569; color: white; width: auto; font-size: 10px; padding: 5px 10px; }
    
    label { font-size: 11px; color: #94a3b8; text-transform: uppercase; display: block; margin-bottom: 5px; }
  </style>
</head>
<body>

<div class="container">
  <div class="card">
    <label>1. Operaciones de Tabla y Multicampo</label>
    <select id="opSelect">
      <optgroup label="Fórmulas de Fila (Varios campos)">
        <option value="SUM_ALL">SUMAR CAMPOS (A + B + C)</option>
        <option value="CONCAT">UNIR TEXTOS (A - B - C)</option>
      </optgroup>
      <optgroup label="Fórmulas de Tabla (Agregación)">
        <option value="TABLE_SUM">SUMA TOTAL DE COLUMNA (lookupRecords)</option>
        <option value="TABLE_COUNT">CONTAR REGISTROS VINCULADOS</option>
        <option value="TABLE_FILTER">FILTRAR Y SUMAR (Condicional de Tabla)</option>
      </optgroup>
    </select>

    <div class="selection-list" id="badgeContainer"></div>
    <button class="btn-reset" id="resetBtn">Limpiar Selección</button>
    
    <label>Fórmula Resultante:</label>
    <div class="formula-output" id="result">Selecciona columnas...</div>
    <button class="btn btn-copy" id="copyBtn">Copiar Fórmula</button>
  </div>

  <div class="card">
    <label>2. Asistente IA de Fórmulas Complejas</label>
    <textarea id="aiInput" rows="3" placeholder="Ej: 'Haz una fórmula que busque el precio en la tabla Productos usando el ID y le sume el IVA'"></textarea>
    <button class="btn btn-ai" id="askAi">Generar con IA</button>
  </div>
</div>

<script>
  let selectedFields = [];
  grist.ready({ requiredAccess: 'full' });

  // Captura de columnas
  grist.on('cursorPos', (pos) => {
    grist.docApi.getColumns(pos.tableId).then(cols => {
      const col = cols.find(c => c.id === pos.columnId || c.colId === pos.columnId);
      if (col && !selectedFields.includes(col.id)) {
        selectedFields.push(col.id);
        update();
      }
    });
  });

  function update() {
    const container = document.getElementById('badgeContainer');
    const resultDiv = document.getElementById('result');
    const op = document.getElementById('opSelect').value;
    
    container.innerHTML = selectedFields.map(f => `<span class="badge">${f}</span>`).join('');
    const fields = selectedFields.map(f => `$${f}`);

    if (fields.length === 0) return;

    let f = "";
    switch(op) {
      case "SUM_ALL": f = `SUM([${fields.join(', ')}])`; break;
      case "CONCAT": f = " + ' ' + ".join(fields); break;
      case "TABLE_SUM": 
        f = `SUM(Nombre_Tabla.lookupRecords(${selectedFields[0]}=${fields[0]}).${selectedFields[1] || 'Campo_A_Sumar'})`;
        break;
      case "TABLE_COUNT":
        f = `len(Nombre_Tabla.lookupRecords(${selectedFields[0]}=${fields[0]}))`;
        break;
      case "TABLE_FILTER":
        f = `SUM(r.${selectedFields[1] || 'Campo'} for r in Nombre_Tabla.all if r.${selectedFields[0]} == ${fields[0]})`;
        break;
    }
    resultDiv.innerText = f;
  }

  // Lógica de IA con localStorage para la API Key
  document.getElementById('askAi').onclick = async () => {
    const query = document.getElementById('aiInput').value;
    const resultDiv = document.getElementById('result');
    
    let apiKey = localStorage.getItem('groq_key');
    if (!apiKey) {
      apiKey = prompt("Introduce tu Groq API Key:");
      if (apiKey) localStorage.setItem('groq_key', apiKey);
      else return;
    }

    resultDiv.innerText = "Generando fórmula...";
    
    try {
      const resp = await fetch("https://api.groq.com/openai/v1/chat/completions", {
        method: "POST",
        headers: { "Authorization": `Bearer ${apiKey}`, "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "llama-3.3-70b-versatile",
          messages: [
            { role: "system", content: "Eres un experto en Grist y Python. Genera solo la fórmula de Grist solicitada, usando sintaxis de Python y símbolos $ para columnas." },
            { role: "user", content: `Columnas disponibles: ${selectedFields.join(', ')}. Tarea: ${query}` }
          ]
        })
      });
      const data = await resp.json();
      resultDiv.innerText = data.choices[0].message.content;
    } catch (e) {
      resultDiv.innerText = "Error al conectar con la IA.";
    }
  };

  document.getElementById('resetBtn').onclick = () => { selectedFields = []; update(); };
  document.getElementById('opSelect').onchange = update;
  document.getElementById('copyBtn').onclick = () => {
    navigator.clipboard.writeText(document.getElementById('result').innerText);
    alert("Fórmula copiada");
  };
</script>
</body>
</html>
