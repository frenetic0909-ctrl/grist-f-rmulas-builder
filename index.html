<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>App Planos - Diagnóstico</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: white; padding: 20px; }
    .card { background: #1e293b; padding: 20px; border-radius: 12px; border: 1px solid #334155; }
    input { width: 100%; padding: 10px; margin: 10px 0; background: #0f172a; color: #38bdf8; border: 1px solid #475569; border-radius: 6px; }
    .btn-action { background: #10b981; color: white; border: none; padding: 12px; border-radius: 6px; width: 100%; cursor: pointer; font-weight: bold; }
    .debug-info { font-size: 10px; color: #94a3b8; margin-top: 15px; border-top: 1px solid #334155; padding-top: 10px; }
  </style>
</head>
<body>

<div class="card">
  <h3>Carga de Plano</h3>
  <input type="text" id="partida" placeholder="Partida">
  <input type="text" id="nro_plano" placeholder="Nro Plano">
  <button class="btn-action" onclick="saveManual()">Probar Guardado</button>
  
  <div class="debug-info" id="debug">Detectando columnas de Grist...</div>
</div>

<script>
  // Iniciamos con acceso completo
  grist.ready({ requiredAccess: 'full' }); 

  // Esta función nos dirá qué ve el widget realmente
  grist.on('message', (msg) => {
    if (msg.tableId) {
      document.getElementById('debug').innerText = "Conectado a tabla: " + msg.tableId;
    }
  });

  async function saveManual() {
    try {
      const table = await grist.getTable();
      const colInfo = await grist.docApi.getColumns(table.tableId);
      
      // Mostramos en consola los IDs reales para que los veas
      console.log("IDs Detectados:", colInfo.map(c => c.id));

      const data = {
        // Probamos sin el $ primero, ya que getTable suele normalizarlo
        "Partida": document.getElementById('partida').value,
        "Nro_Plano": document.getElementById('nro_plano').value
      };

      await table.create(data);
      alert("✅ ¡Enviado! Revisa si ahora se ve el dato.");
    } catch (e) {
      // Si falla, intentamos con el símbolo $ explícito
      try {
        const table = await grist.getTable();
        const dataDollar = {
          "$Partida": document.getElementById('partida').value,
          "$Nro_Plano": document.getElementById('nro_plano').value
        };
        await table.create(dataDollar);
        alert("✅ Enviado con formato $");
      } catch (err2) {
        alert("Error Final: " + err2.message);
      }
    }
  }
</script>
</body>
</html>
