<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>App de GestiÃ³n de Planos - ARBA</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f1f5f9; color: #1e293b; margin: 0; padding: 20px; display: flex; gap: 20px; }
    .column { flex: 1; display: flex; flex-direction: column; gap: 15px; }
    .card { background: white; padding: 20px; border-radius: 10px; shadow: 0 4px 6px rgba(0,0,0,0.1); border-top: 4px solid #3b82f6; }
    h3 { margin-top: 0; font-size: 16px; color: #1d4ed8; text-transform: uppercase; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px; }
    
    label { font-size: 11px; font-weight: bold; color: #64748b; display: block; margin-bottom: 4px; }
    input, select, textarea { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 5px; margin-bottom: 10px; box-sizing: border-box; }
    
    .btn { padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.2s; }
    .btn-save { background: #2563eb; color: white; }
    .btn-import { background: #10b981; color: white; margin-top: 5px; }
    
    .list-container { max-height: 400px; overflow-y: auto; font-size: 13px; }
    .plano-item { padding: 10px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; }
    .plano-item:hover { background: #f8fafc; }
    .tag { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; }
    .tag-blue { background: #dbeafe; color: #1e40af; }
  </style>
</head>
<body>

  <div class="column">
    <div class="card">
      <h3>ðŸ†• Carga Manual</h3>
      <label>Partida</label>
      <input type="text" id="partida" placeholder="055-XXXXXX-X">
      <label>NÃºmero de Plano</label>
      <input type="text" id="nro_plano" placeholder="PH-2026-...">
      <label>Estado</label>
      <select id="estado">
        <option value="Pendiente">Pendiente</option>
        <option value="Aprobado">Aprobado</option>
      </select>
      <button class="btn btn-save" id="btnSave">Guardar Plano</button>
    </div>

    <div class="card">
      <h3>ðŸ“¥ Importar Datos (Excel)</h3>
      <label>Seleccionar .xlsx o .csv</label>
      <input type="file" id="importFile" accept=".xlsx, .xls, .csv">
      <button class="btn btn-import" id="btnImport">Procesar Archivo</button>
      <div id="importStatus" style="font-size: 11px; margin-top: 5px; color: #10b981;"></div>
    </div>
  </div>

  <div class="column">
    <div class="card" style="border-top-color: #10b981;">
      <h3>ðŸ“‹ Listado de Planos Existentes</h3>
      <div class="list-container" id="planoList">
        Cargando registros...
      </div>
    </div>
  </div>

<script>
  const TABLE_NAME = "Planos"; // Cambia esto al nombre exacto de tu tabla en Grist
  grist.ready({ requiredAccess: 'full' });

  // 1. CARGA MANUAL
  document.getElementById('btnSave').onclick = async () => {
    const data = {
      Partida: document.getElementById('partida').value,
      Nro_Plano: document.getElementById('nro_plano').value,
      Estado: document.getElementById('estado').value,
      Fecha: new Date().toISOString()
    };
    try {
      await grist.docApi.addRecords(TABLE_NAME, [data]);
      alert("Guardado correctamente");
      document.querySelectorAll('input[type="text"]').forEach(i => i.value = "");
    } catch (e) { alert("Error: " + e.message); }
  };

  // 2. IMPORTACIÃ“N MASIVA
  document.getElementById('btnImport').onclick = async () => {
    const file = document.getElementById('importFile').files[0];
    if (!file) return alert("Selecciona un archivo primero");
    
    const reader = new FileReader();
    reader.onload = async (e) => {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet);
      
      try {
        await grist.docApi.addRecords(TABLE_NAME, json);
        document.getElementById('importStatus').innerText = `âœ… Se importaron ${json.length} filas.`;
      } catch (err) { alert("Error al importar: " + err.message); }
    };
    reader.readAsArrayBuffer(file);
  };

  // 3. VISUALIZACIÃ“N EN TIEMPO REAL
  grist.onRecords((records) => {
    const list = document.getElementById('planoList');
    if (records.length === 0) {
      list.innerHTML = "No hay registros cargados.";
      return;
    }
    list.innerHTML = records.map(r => `
      <div class="plano-item">
        <div>
          <b>${r.Partida || 'S/P'}</b><br>
          <span style="color: #64748b">${r.Nro_Plano || 'Sin Nro'}</span>
        </div>
        <span class="tag tag-blue">${r.Estado}</span>
      </div>
    `).reverse().join('');
  });
</script>

</body>
</html>
