<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Grist Master Assistant</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: white; padding: 15px; margin: 0; }
    .section-title { font-size: 12px; color: #f59e0b; font-weight: bold; text-transform: uppercase; margin-bottom: 10px; display: block; }
    .card { background: #1e293b; border: 1px solid #334155; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    
    /* Estilos del Asistente */
    .ai-container { background: #020617; border: 2px solid #f59e0b; padding: 15px; border-radius: 10px; }
    textarea { width: 100%; background: #1e293b; color: white; border: 1px solid #475569; border-radius: 6px; padding: 10px; resize: none; box-sizing: border-box; }
    
    .selection-display { background: #0f172a; padding: 8px; border-radius: 5px; font-size: 11px; color: #38bdf8; margin-bottom: 10px; min-height: 20px; }
    .formula-result { background: #020617; color: #10b981; padding: 15px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 13px; border: 1px solid #10b981; margin-top: 10px; }
    
    .btn { padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.2s; }
    .btn-ai { background: #f59e0b; color: #020617; font-size: 14px; margin-top: 10px; }
    .btn-copy { background: #10b981; color: white; margin-top: 10px; }
    .btn-reset { background: #475569; color: white; width: auto; font-size: 10px; padding: 5px 10px; margin-bottom: 10px; }
  </style>
</head>
<body>

  <span class="section-title">1. Selección de Columnas Técnicas</span>
  <div class="card">
    <div class="selection-display" id="colList">⚠️ Haz clic en las columnas de tu tabla...</div>
    <button class="btn-reset" onclick="resetCols()">Limpiar Selección</button>
  </div>

  <span class="section-title">2. Asistente IA de Fórmulas</span>
  <div class="ai-container">
    <textarea id="aiPrompt" rows="3" placeholder="Ej: 'Suma estas columnas y si el resultado es mayor a 100 pone Vencido'"></textarea>
    <button class="btn btn-ai" id="runAi">✨ Generar Fórmula con IA</button>
  </div>

  <div id="resultArea" style="display:none;">
    <span class="section-title" style="margin-top:20px;">3. Código Python Generado</span>
    <div class="formula-result" id="finalFormula"></div>
    <button class="btn btn-copy" onclick="copyFormula()">Copiar para Grist</button>
  </div>

<script>
  let selected = [];
  grist.ready({ requiredAccess: 'full' });

  // Captura de Columnas
  grist.on('cursorPos', (pos) => {
    grist.docApi.getColumns(pos.tableId).then(cols => {
      const col = cols.find(c => c.id === pos.columnId || c.colId === pos.columnId);
      if (col && !selected.includes(col.id)) {
        selected.push(col.id);
        document.getElementById('colList').innerText = "Columnas: " + selected.join(', ');
      }
    });
  });

  function resetCols() {
    selected = [];
    document.getElementById('colList').innerText = "⚠️ Haz clic en las columnas...";
    document.getElementById('resultArea').style.display = "none";
  }

  // Lógica del Asistente
  document.getElementById('runAi').onclick = async () => {
    const prompt = document.getElementById('aiPrompt').value;
    const resultBox = document.getElementById('finalFormula');
    const resultArea = document.getElementById('resultArea');

    if (selected.length === 0) {
      alert("Primero selecciona al menos una columna de la tabla.");
      return;
    }

    let apiKey = localStorage.getItem('groq_key');
    if (!apiKey) {
      apiKey = window.prompt("Introduce tu Groq API Key (se guardará en este navegador):");
      if (apiKey) localStorage.setItem('groq_key', apiKey);
      else return;
    }

    resultArea.style.display = "block";
    resultBox.innerText = "⏳ Pensando fórmula...";

    try {
      const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
        method: "POST",
        headers: { "Authorization": `Bearer ${apiKey}`, "Content-Type": "application/json" },
        body: JSON.stringify({
          model: "llama-3.3-70b-versatile",
          messages: [
            { role: "system", content: "Eres un experto en Grist. Crea fórmulas de Python usando los nombres de columnas que el usuario seleccionó. Usa siempre el formato $NombreColumna." },
            { role: "user", content: `Columnas seleccionadas: ${selected.join(', ')}. Orden: ${prompt}` }
          ]
        })
      });
      const data = await response.json();
      resultBox.innerText = data.choices[0].message.content;
    } catch (e) {
      resultBox.innerText = "Error: Verifica tu conexión o API Key.";
    }
  };

  function copyFormula() {
    navigator.clipboard.writeText(document.getElementById('finalFormula').innerText);
    alert("Fórmula copiada.");
  }
</script>
</body>
</html>
