<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    body {
      font-family: system-ui, sans-serif;
      text-align: center;
      padding: 16px;
    }
    button {
      padding: 10px 16px;
      font-weight: bold;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    #status {
      margin-top: 12px;
      font-size: 13px;
    }
  </style>
</head>

<body>
  <button id="reloadBtn">üîÑ Force Reload</button>
  <div id="status">Inicializando‚Ä¶</div>

<script>
grist.ready(async () => {

  // üîì PASO CR√çTICO: habilita interacci√≥n del widget
  grist.onRecord(() => {});

  // üîê Permitir requests externas
  grist.allowExternalRequests();

  const btn = document.getElementById("reloadBtn");
  const status = document.getElementById("status");

  const BASE_URL = "https://glozingly-phytographic-anika.ngrok-free.dev";

  // ü©∫ Health check del bridge
  try {
    const health = await grist.fetch(`${BASE_URL}/health`);
    if (!health.ok) throw new Error();
    status.textContent = "üü¢ Bridge online";
    status.style.color = "#16a34a";
  } catch (e) {
    console.error(e);
    status.textContent = "üî¥ Bridge no disponible";
    status.style.color = "#dc2626";
    return;
  }

  // üîò Acci√≥n del bot√≥n
  btn.addEventListener("click", async () => {
    btn.disabled = true;
    status.textContent = "‚è≥ Enviando solicitud‚Ä¶";
    status.style.color = "#475569";

    try {
      // ‚úÖ API correcta para obtener el docId
      const info = await grist.getDocPageInfo();

      const res = await grist.fetch(`${BASE_URL}/force-reload`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ doc_id: info.docId })
      });

      if (!res.ok) {
        const txt = await res.text();
        throw new Error(txt);
      }

      status.textContent = "‚úÖ Reload solicitado correctamente";
      status.style.color = "#16a34a";

    } catch (e) {
      console.error(e);
      status.textContent = "‚ùå Error al ejecutar reload";
      status.style.color = "#dc2626";
    } finally {
      btn.disabled = false;
    }
  });
});
</script>
</body>
</html>
