<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    body {
      font-family: system-ui, sans-serif;
      text-align: center;
      padding: 16px;
    }
    button {
      padding: 10px 16px;
      font-weight: bold;
      cursor: pointer;
    }
    #status {
      margin-top: 12px;
      font-size: 13px;
    }
  </style>
</head>

<body>
  <button id="reloadBtn">üîÑ Force Reload</button>
  <div id="status">Inicializando‚Ä¶</div>

<script>
grist.ready(async () => {
  console.log("‚úÖ grist.ready");

  // üîê OBLIGATORIO
  grist.allowExternalRequests();
  console.log("üîì External requests allowed");

  const btn = document.getElementById("reloadBtn");
  const status = document.getElementById("status");

  const BASE_URL = "https://glozingly-phytographic-anika.ngrok-free.dev";

  // Health check
  try {
    console.log("üåê Checking health...");
    const health = await grist.fetch(`${BASE_URL}/health`);
    console.log("Health response:", health.status);

    status.textContent = "üü¢ Bridge online";
    status.style.color = "#16a34a";
  } catch (e) {
    console.error("Health error:", e);
    status.textContent = "üî¥ Bridge no disponible";
    status.style.color = "#dc2626";
    return;
  }

  btn.onclick = async () => {
    console.log("üñ±Ô∏è Button clicked");

    btn.disabled = true;
    status.textContent = "‚è≥ Enviando solicitud‚Ä¶";
    status.style.color = "#475569";

    try {
      const info = await grist.getDocPageInfo();
      console.log("üìÑ Doc info:", info);

      const res = await grist.fetch(`${BASE_URL}/force-reload`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ doc_id: info.docId })
      });

      console.log("POST response:", res.status);

      if (!res.ok) {
        const txt = await res.text();
        throw new Error(txt);
      }

      status.textContent = "‚úÖ Reload solicitado";
      status.style.color = "#16a34a";

    } catch (e) {
      console.error("POST error:", e);
      status.textContent = "‚ùå Error al ejecutar reload";
      status.style.color = "#dc2626";
    } finally {
      btn.disabled = false;
    }
  };
});
</script>
</body>
</html>
